<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <title>Live Streaming Demonstration</title>
  </head>
  <body>
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <div class="container">
      <div class="row">
        <div class="col-lg-8 offset-lg-2">
          <div>
            <h3 class="mt-5">Live Streaming</h3>
            <a href="/cameras">
              <button class="btn btn-primary mt-3">Manage Cameras</button>
            </a>
          </div>

          <hr />
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">Live Camera Feeds</h1>
            <button
              id="refreshButton"
              class="btn btn-secondary d-flex align-items-center"
            >
              <span id="buttonText">Refresh Cameras</span>
              <span
                id="spinner"
                class="spinner-border spinner-border-sm ms-2"
                style="display: none"
                role="status"
                aria-hidden="true"
              ></span>
            </button>
          </div>
          <div class="mt-3"></div>

          {% for id, cam in cameras.items() %}
          <div class="card mb-4">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h4>{{ cam.name }}</h4>
              <div>
                <span id="faceCount-{{ id }}">Faces: 0</span> |
                <span id="confidences-{{ id }}">Conf: -</span>
              </div>
            </div>
            <div class="card-body">
              <img
                src="{{ url_for('main.video_feed', camera_id=id) }}"
                width="100%"
                class="camera-feed"
                data-id="{{ id }}"
                style="cursor: pointer"
              />

              <div class="mt-2" id="snapshots-{{ id }}"></div>
            </div>
          </div>
          {% endfor %}
          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
          <script type="text/javascript">
            const cameraList = JSON.parse(`{{ cameras | tojson | safe }}`);
          </script>

          <script>
            document.querySelectorAll(".camera-feed").forEach((img) => {
              img.addEventListener("click", () => {
                if (img.requestFullscreen) {
                  img.requestFullscreen();
                } else if (img.webkitRequestFullscreen) {
                  img.webkitRequestFullscreen(); // Safari
                } else if (img.msRequestFullscreen) {
                  img.msRequestFullscreen(); // IE11
                }
              });
            });
            document
              .getElementById("refreshButton")
              .addEventListener("click", function () {
                // Show spinner and hide button text
                document.getElementById("spinner").style.display =
                  "inline-block";
                document.getElementById("buttonText").style.display = "none";

                fetch("/refresh_cameras")
                  .then((response) => response.json())
                  .then((data) => {
                    if (data.success) {
                      // Hide spinner and show button text
                      document.getElementById("spinner").style.display = "none";
                      document.getElementById("buttonText").style.display =
                        "inline";
                      console.log(data);

                      location.reload();
                    } else {
                      alert("Failed to refresh cameras.");
                    }
                  })
                  .catch((error) => {
                    console.error("Error refreshing cameras:", error);
                    // Hide spinner and show button text in case of error
                    document.getElementById("spinner").style.display = "none";
                    document.getElementById("buttonText").style.display =
                      "inline";
                  });
              });

            function updateAllStats() {
              Object.keys(cameraList).forEach((id) => {
                fetch(`/camera_stats/${id}`)
                  .then((res) => res.json())
                  .then((data) => {
                    const faceEl = document.getElementById(`faceCount-${id}`);
                    const confEl = document.getElementById(`confidences-${id}`);
                    if (faceEl && confEl) {
                      faceEl.innerText = `Faces: ${data.count}`;
                      confEl.innerText = `Conf: ${data.confidences.join(", ")}`;
                    }
                  });

                fetch(`/snapshots/${id}`)
                  .then((res) => res.json())
                  .then((data) => {
                    const div = document.getElementById(`snapshots-${id}`);
                    if (div) {
                      div.innerHTML = "";
                      data.snapshots.forEach((file) => {
                        const img = document.createElement("img");
                        img.src = `/static/snapshots/${file}`;
                        img.width = 80;
                        img.className = "mr-2 mb-2";
                        div.appendChild(img);
                      });
                    }
                  });
              });
            }
            setInterval(updateAllStats, 1000);
          </script>
        </div>
      </div>
    </div>
  </body>
</html>
